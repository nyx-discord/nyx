"use strict";(self.webpackChunk_nyx_discord_docs=self.webpackChunk_nyx_discord_docs||[]).push([[6034],{1658:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>u,contentTitle:()=>h,default:()=>x,frontMatter:()=>a,metadata:()=>s,toc:()=>p});const s=JSON.parse('{"id":"features/schedules/schedule-overview","title":"\ufe0f\u23f0 Schedules","description":"Hey there \ud83d\udc4b!  This guide is here to give you a fast understanding of how nyx\'s schedule system works, so you can use it","source":"@site/docs/features/schedules/schedule-overview.mdx","sourceDirName":"features/schedules","slug":"/features/schedules/schedule-overview","permalink":"/nyx/docs/features/schedules/schedule-overview","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/features/schedules/schedule-overview.mdx","tags":[],"version":"current","frontMatter":{"title":"\ufe0f\u23f0 Schedules"},"sidebar":"nyxSidebar","previous":{"title":"\ud83d\udce3 Command Event Bus","permalink":"/nyx/docs/features/commands/command-bus"},"next":{"title":"\ufe0f\u231a Schedules","permalink":"/nyx/docs/features/schedules/schedule"}}');var n=o(3159),r=o(5912),i=o(5610),c=o(7598),d=(o(1855),o(8759));function l(){const e=[{label:"\ud83d\udc64 You",color:"#2a9fd6",id:"you"},{label:(0,n.jsxs)("p",{children:["\ud83d\udcbc ",(0,n.jsx)("a",{href:"./schedule-manager",children:(0,n.jsx)("code",{children:"ScheduleManager"})})]}),color:"#ff595e",id:"manager"},{label:(0,n.jsxs)("p",{children:["\ud83d\ude8c ",(0,n.jsx)("a",{href:"./schedule-repository",children:(0,n.jsx)("code",{children:"ScheduleRepository"})})]}),color:"#ff924c",id:"repository"},{label:(0,n.jsxs)("p",{children:["\u23f0 ",(0,n.jsx)("a",{href:"./schedule-scheduler",children:(0,n.jsx)("code",{children:"ScheduleExecutionScheduler"})})]}),color:"#ffffff",id:"scheduler"},{label:(0,n.jsxs)("p",{children:["\ud83e\udde9 ",(0,n.jsx)("a",{href:"./schedule-scheduler#-job-adapters",children:(0,n.jsx)("code",{children:"ScheduleJobAdapter"})})]}),color:"#f7d7c4",id:"adapter"},{label:(0,n.jsxs)("p",{children:["\u26a1 ",(0,n.jsx)("a",{href:"./schedule-executor",children:(0,n.jsx)("code",{children:"ScheduleExecutor"})})]}),color:{dark:"#FFD166",light:"#ffba1a"},id:"executor"},{label:(0,n.jsxs)("p",{children:["\ufe0f\ud83d\udee1\ufe0f  ",(0,n.jsx)("a",{href:"./schedule-interception#-schedule-middlewares",children:(0,n.jsx)("code",{children:"MiddlewareList"})})]}),color:"#8ac926",id:"middleware"},{label:(0,n.jsxs)("p",{children:["\ud83d\udcab ",(0,n.jsx)("a",{href:"../error/error-handling",children:(0,n.jsx)("code",{children:"ErrorHandler"})})]}),color:"#92162D",id:"errorHandler"}],t=[{from:"you",steps:[{to:"manager",label:"Add a new schedule"},{to:"repository",label:"Add schedule to repository"}]},{from:"manager",steps:[{to:"scheduler",label:"Track schedule"},{to:"adapter",label:"Instantiate new job adapter for this schedule"}]},{from:"adapter",to:"you",label:"Return new job adapter"},{from:"adapter",to:"adapter",label:"Wait for scheduled time"},{from:"adapter",steps:[{to:"executor",label:"Execute schedule"},{to:"middleware",label:"Check middleware list",tooltip:"If there are middlewares registered"}]},{from:"middleware",to:"middleware",label:"Check all registered middlewares"},{from:"middleware",to:"executor",label:"Return allowed or denied",tooltip:"Workflow ends if denied"},{from:"executor",to:"executor",label:"Tick schedule"},{from:"executor",to:"errorHandler",label:"Pass thrown errors, if any",tooltip:"Workflow ends if it errored",animated:!0},{from:"executor",to:"adapter",label:"Finish execution",tooltip:(0,n.jsxs)("p",{children:["Emits ",(0,n.jsx)("code",{children:"ScheduleEventEnum.ScheduleTick"})]})}];return(0,d.$)({actors:e,events:t,id:"schedule-overview",height:"65vh"})}const a={title:"\ufe0f\u23f0 Schedules"},h="\ufe0f\u23f0 Schedules",u={},p=[{value:"\ud83d\udcda Description",id:"-description",level:2},{value:"\ud83d\udd22 Schedule tick sequence",id:"-schedule-tick-sequence",level:2},{value:"\u2728 Quick examples",id:"-quick-examples",level:2}];function f(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.header,{children:(0,n.jsx)(t.h1,{id:"\ufe0f-schedules",children:"\ufe0f\u23f0 Schedules"})}),"\n","\n",(0,n.jsx)(t.p,{children:"Hey there \ud83d\udc4b!  This guide is here to give you a fast understanding of how nyx's schedule system works, so you can use it\nright away. For in-depth details, see the respective guides of each schedule related object."}),"\n",(0,n.jsx)(t.h2,{id:"-description",children:"\ud83d\udcda Description"}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"Schedules"})," are objects that are ticked some time in the future, and can be used as a feature complete way of scheduling\nevents in your bot, apart from Node's ",(0,n.jsx)(t.code,{children:"setInterval()"})," API."]}),"\n",(0,n.jsxs)(t.p,{children:["In essence, a ",(0,n.jsx)(t.code,{children:"Schedule"})," object contains its ticking logic and its interval of when it wishes to be executed, which\ncan be in ",(0,n.jsx)(t.a,{href:"https://crontab.guru/",children:"cron"})," format, in an amount of ms (",(0,n.jsx)(t.code,{children:"number"}),"), or as a ",(0,n.jsx)(t.code,{children:"Date"}),". When a schedule is added\nvia the ",(0,n.jsx)(t.code,{children:"ScheduleManager"}),", the ",(0,n.jsx)(t.code,{children:"ScheduleExecutionScheduler"})," creates a new ",(0,n.jsx)(t.code,{children:"ScheduleJobAdapter"})," for it, which will start\nticking the schedule using the ",(0,n.jsx)(t.code,{children:"ScheduleExecutor"}),"."]}),"\n",(0,n.jsxs)(t.admonition,{type:"danger",children:[(0,n.jsxs)(t.p,{children:["It's important to note that the ",(0,n.jsx)(t.code,{children:"ScheduleExecutionScheduler"})," is implementation-specific. For example, ",(0,n.jsx)(t.code,{children:"@framework"}),"'s\nimplementation uses the ",(0,n.jsx)(t.a,{href:"https://www.npmjs.com/package/cron",children:"cron npm package"})," to create the job."]}),(0,n.jsxs)(t.p,{children:["To add a layer of abstraction, the ",(0,n.jsx)(t.code,{children:"ScheduleExecutionScheduler"}),"'s interface doesn't return any specific job type, but\nrather a ",(0,n.jsx)(t.code,{children:"ScheduleJobAdapter"}),", which has methods like resume, pause, etc."]}),(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"ScheduleJobAdapters"})," do not tick schedules by themselves. They're meant to be a wrapper around an object that actually\ndoes so, like a ",(0,n.jsx)(t.code,{children:"cron"})," job, a ",(0,n.jsx)(t.code,{children:"setInterval()"})," interval, to be able to interact with them without actually knowing the\nactual implementation, or what's \"inside\". However because of their nature, they're also implementation-specific."]})]}),"\n",(0,n.jsxs)(t.p,{children:["The schedule system is made up of several objects that work together to track the execution of schedule objects, all\ncoordinated by a ",(0,n.jsx)(t.code,{children:"ScheduleManager"}),"."]}),"\n",(0,n.jsx)(t.p,{children:"Specifically, the schedule related objects are:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"ScheduleManager"}),": The entry point for the schedule system, holding all the schedule-related objects and methods that\nuse all of these objects. All objects below are contained here."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"ScheduleExecutionScheduler"}),": Tracks the execution of schedules and stores the ",(0,n.jsx)(t.code,{children:"ScheduleJobAdapters"}),"."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"ScheduleRepository"}),": Stores all the currently registered schedules."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"ScheduleExecutor"}),": Executes schedules, checking its ",(0,n.jsx)(t.code,{children:"ScheduleMiddlewareList"})," and passing any errors to\nits ",(0,n.jsx)(t.code,{children:"ErrorHandler"}),"."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"EventBus"}),": An ",(0,n.jsx)(t.a,{href:"../events/event-bus",children:"\ud83d\udce3 Event Bus"})," that emits schedule related events."]}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"-schedule-tick-sequence",children:"\ud83d\udd22 Schedule tick sequence"}),"\n",(0,n.jsx)(t.admonition,{type:"tip",children:(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"A dashed step means it's executed asynchronously, so the next one is inmediately executed."}),"\n",(0,n.jsxs)(t.li,{children:["You can hover over steps with ",(0,n.jsx)(t.code,{children:"(?)"})," to see extra details."]}),"\n"]})}),"\n","\n",(0,n.jsx)(l,{}),"\n",(0,n.jsx)(t.h2,{id:"-quick-examples",children:"\u2728 Quick examples"}),"\n",(0,n.jsxs)(i.A,{children:[(0,n.jsxs)(c.A,{value:"Creating a StatusSchedule",children:[(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsxs)(t.li,{children:["Extend ",(0,n.jsx)(t.code,{children:"AbstractSchedule"}),", implementing ",(0,n.jsx)(t.code,{children:"tick()"})," and ",(0,n.jsx)(t.code,{children:"interval"}),"."]}),"\n",(0,n.jsxs)(t.li,{children:["Register it to a bot's ",(0,n.jsx)(t.code,{children:"ScheduleManager"}),"."]}),"\n"]}),(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-ts",children:"class StatusSchedule extends AbstractSchedule {\n  // Cron format (every half hour). Can also be a Date or number.\n  protected readonly interval = '*/30 * * * *';\n\n  public async tick(meta: ScheduleTickMeta) {\n    const bot = meta.getBot();\n    const { client } = bot;\n\n    const guildsAmount = client.guilds.cache.size;\n    client.user.setActivity(`${guildsAmount} servers`, { type: ActivityType.Watching });\n  }\n}\n\nconst schedule = new StatusSchedule();\nawait bot.getScheduleManager().addSchedule(schedule);\n"})})]}),(0,n.jsxs)(c.A,{value:"Pausing a Schedule",children:[(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Get the job that ticks the schedule. Either:"}),"\n"]}),(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["From the ",(0,n.jsx)(t.code,{children:"ScheduleExecutionScheduler"})," via ",(0,n.jsx)(t.code,{children:"ScheduleExecutionScheduler#getJobForSchedule()"}),"."]}),"\n",(0,n.jsxs)(t.li,{children:["From the ",(0,n.jsx)(t.code,{children:"Schedule"}),", via ",(0,n.jsx)(t.code,{children:"Schedule#getJob()"}),", passing the bot."]}),"\n",(0,n.jsxs)(t.li,{children:["From the ",(0,n.jsx)(t.code,{children:"ScheduleManager"})," when adding the schedule."]}),"\n"]}),(0,n.jsxs)(t.ol,{start:"2",children:["\n",(0,n.jsxs)(t.li,{children:["Pause the job via ",(0,n.jsx)(t.code,{children:"ScheduleJobAdapter#pause()"}),"."]}),"\n"]}),(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-ts",children:"// One of:\nconst job = bot.getScheduleManager().getScheduler().getJobForSchedule(schedule);\nconst job = schedule.getJob(bot);\nconst job = await bot.getScheduleManager().addSchedule(schedule);\n\n// Then:\nawait job.pause();\n"})})]})]})]})}function x(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(f,{...e})}):f(e)}},8759:(e,t,o)=>{o.d(t,{$:()=>k});var s=o(2552),n=o(4415),r=(o(5023),o(1855)),i=o(6840);function c(e){return e+50}function d(e){return e-5}function l(e){return 1===e?120:120+90*(e-1)}function a(e){return e+270}function h(e){const t=u(e).length-15;return t>0?12*t:0}function u(e){if(null===e)return"";switch(typeof e){case"string":case"number":return e.toString();case"boolean":return"";case"object":return e instanceof Array?e.map(u).join(""):"props"in e?u(e.props.children):"";default:return console.warn("Unresolved `node` of type:",typeof e,e),""}}var p=o(3159);const f=(0,r.memo)((e=>{let{data:t}=e;const{label:o,width:r,height:c}=t,{colorMode:d}=(0,s.G)(),l=t.color??{},a="string"==typeof l?l:l[d];return(0,p.jsxs)("div",{className:"actor-node",children:[(0,p.jsx)(n.h7,{type:"source",position:i.yX.Left,id:"s-left"}),(0,p.jsx)(n.h7,{type:"source",position:i.yX.Right,id:"s-right"}),(0,p.jsx)("div",{className:"actor-node__body",style:{width:r??4,height:c??60,backgroundColor:a??("dark"===d?"#585858":"#BABABA")},children:o&&(0,p.jsx)("div",{className:"actor-node__label",style:{width:270+h(o)},children:o})}),(0,p.jsx)(n.h7,{type:"target",position:i.yX.Left,id:"t-left"}),(0,p.jsx)(n.h7,{type:"target",position:i.yX.Right,id:"t-right"})]})})),x="actorNode";function m(e){return`label-${e}`}function j(e,t){return`line-${e}-${t}`}function b(e,t,o){return`label-${e}-${t}-${o}`}function g(e){let{from:t,to:o,fromHandle:s,toHandle:n,animated:r}=e;return{id:`${t}-${o}`,source:t,sourceHandle:`s-${s}`,target:o,targetHandle:`t-${n}`,markerEnd:{type:i.TG.ArrowClosed},type:i.Do.SmoothStep,animated:r}}const y=(0,r.memo)((e=>{let{data:{label:t,width:o,tooltip:s}}=e;return(0,p.jsxs)("div",{className:"step-node",children:[s&&(0,p.jsxs)("div",{className:"step-node__tooltip",children:[(0,p.jsx)("svg",{className:"step-node__tooltip-icon",viewBox:"0 0 16 16",preserveAspectRatio:"X200Y200 meet",xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",children:(0,p.jsx)("path",{d:"M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286m1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94"})}),(0,p.jsx)("span",{className:"step-node__tooltip-label",children:s})]}),(0,p.jsx)(n.h7,{type:"source",position:i.yX.Left,id:"s-left"}),(0,p.jsx)(n.h7,{type:"source",position:i.yX.Right,id:"s-right"}),(0,p.jsx)(n.h7,{type:"source",position:i.yX.Top,id:"s-top"}),(0,p.jsx)(n.h7,{type:"source",position:i.yX.Bottom,id:"s-bottom"}),(0,p.jsx)("div",{className:"step-node__label",style:{width:o??200},children:t}),(0,p.jsx)(n.h7,{type:"target",position:i.yX.Left,id:"t-left"}),(0,p.jsx)(n.h7,{type:"target",position:i.yX.Right,id:"t-right"}),(0,p.jsx)(n.h7,{type:"target",position:i.yX.Top,id:"t-top"}),(0,p.jsx)(n.h7,{type:"target",position:i.yX.Bottom,id:"t-bottom"})]})})),w="stepNode";function v(e,t){const o=[],s=Object.create(null);let n=0,r=0;for(const c of e){const e=a(r)+n;s[c.id]={...c,x:e},r=e,n=h(c.label)}let i=1;for(const[a,h]of t.entries()){const e=s[h.from];if(!e)throw new Error(`A sequence starts from: ${h.from}, but no such actor exists. Sequence: ${S(h)}`);const n="steps"in h?h.steps:[h],r=n.find((e=>e.to===h.from));if(r){if(n.length>1)throw new Error("A sequence with a self-referencing step cannot have more than one step.");i++;const s={id:b(i,e.id,e.id),position:{x:c(e.x),y:d(l(i))+(r.offset??0)},data:{label:r.label,tooltip:r.tooltip},type:w};o.push(s);const u=t[a-1];if(u){const e="steps"in u?{...u.steps[0],from:u.from}:u;if(e.from===h.from&&e.to===h.from)continue}const p={id:j(i-1,e.id),position:{x:e.x-1,y:l(i-1)},data:{color:e.color},type:x};o.push(p);continue}const f=t[a-1];if(f){const t="steps"in f?{...f.steps[0],from:f.from}:f;t.from===h.from&&t.to===h.from&&(i++,o.push({id:j(i,e.id),position:{x:e.x-1,y:l(i)},data:{color:e.color},type:x}),i++)}o.push({id:j(i,e.id),position:{x:e.x-1,y:l(i)},data:{color:e.color},type:x});let m=e;for(const t of n){const e=s[t.to];if(!e)throw new Error(`A sequence leads to: ${t.to}, but no such actor exists. Step: ${S(t)}`);const n=Math.min(e.x,m.x);o.push({id:b(i,m.id,e.id),position:{x:c(n),y:d(l(i))+(t.offset??0)},data:{label:t.label,width:(u=m.x,p=e.x,Math.abs(p-u)-100),tooltip:t.tooltip},type:w}),o.push({id:j(i,e.id),position:{x:e.x-1,y:l(i)},data:{color:e.color},type:x}),m=e}i++}var u,p;const f=l(i-1)+90-50;var g;for(const c of e){const e=s[c.id].x,t={id:(g=c.id,`actorLine-${g}`),position:{x:e,y:50},data:{height:f,width:2},type:x},n={id:m(c.id),position:{x:e-2,y:50},data:{color:c.color,label:c.label,width:6,height:50},type:x};o.unshift(t,n)}return o}function S(e){const t=[];return JSON.stringify(e,(function(e,o){if(null!=o&&"object"==typeof o){if(t.indexOf(o)>=0)return;t.push(o)}return o}))}const k=e=>{const t=v(e.actors,e.events),o=function(e,t){const o=[];let s=1;for(const[n,r]of t.entries()){const i="steps"in r?r.steps:[r];if(0===i.length)throw new Error(`No steps in sequence: ${JSON.stringify(r)}`);let c=r.from;for(const[d,l]of i.entries()){if(r.from===l.to){const e=t[n-1];if(e){const t="steps"in e?{...e.steps[0],from:e.from}:e;if(t.from===t.to&&t.to===r.from){const e=g({from:b(s-1,l.to,l.to),to:b(s,l.to,l.to),fromHandle:"bottom",toHandle:"top",animated:l.animated});o.push(e);continue}}const i=g({from:j(s,c),to:b(s+1,c,l.to),fromHandle:"right",toHandle:"top",animated:l.animated});o.push(i),s++;continue}{const e=t[n-1];if(e&&0===d){const t="steps"in e?{...e.steps[0],from:e.from}:e;if(t.from===t.to){const e=g({from:b(s-1,t.to,t.to),to:j(s,t.to),fromHandle:"bottom",toHandle:"right",animated:t.animated});s++,o.push(e)}}}const i=j(s,c),a=j(s,l.to),h=b(s,c,l.to),u=e.findIndex((e=>e.id===c)),p=e.findIndex((e=>e.id===l.to))>u,f=g({from:i,to:h,fromHandle:p?"right":"left",toHandle:p?"left":"right",animated:l.animated}),x=g({from:h,to:a,fromHandle:p?"right":"left",toHandle:p?"left":"right",animated:l.animated});o.push(f,x),c=l.to}s++}return o}(e.actors,e.events);e.beforeNodes&&t.unshift(...e.beforeNodes),e.afterNodes&&t.push(...e.afterNodes);const{colorMode:i}=(0,s.G)(),c=(0,r.useMemo)((()=>({[w]:y,[x]:f})),[t,o]);return(0,p.jsx)("div",{style:{height:e.height??"60vh"},children:(0,p.jsxs)(n.Gc,{id:e.id,className:"sequence-diagram",nodes:t,edges:o,colorMode:i,edgesReconnectable:!1,elementsSelectable:!1,nodesDraggable:!1,onNodeMouseEnter:(e,t)=>t.data.isHovering=!0,onNodeMouseLeave:(e,t)=>t.data.isHovering=!1,nodeTypes:c,minZoom:0,fitView:void 0===e.defaultViewport,defaultViewport:e.defaultViewport,children:[(0,p.jsx)(n.VS,{id:e.id,className:"sequence-diagram__background",variant:n._5.Dots,size:1,bgColor:"dark"===i?"#212121":"#f6f8fa"}),(0,p.jsx)(n.H2,{className:"sequence-diagram__controls",fitViewOptions:{duration:200},showInteractive:!1})]})})}}}]);